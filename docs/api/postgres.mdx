---
title: "@icetype/postgres API"
description: API reference for the @icetype/postgres package - PostgreSQL DDL generation from IceType schemas.
---

# @icetype/postgres API

The `@icetype/postgres` package transforms IceType schemas to PostgreSQL DDL (Data Definition Language) statements. Compatible with [postgres.do](https://postgres.do) and Drizzle ORM.

## Installation

```bash
npm install @icetype/postgres
# or
pnpm add @icetype/postgres
```

## Quick Start

```typescript
import { parseSchema } from '@icetype/core';
import { PostgresAdapter, transformToPostgresDDL } from '@icetype/postgres';

// Parse an IceType schema
const schema = parseSchema({
  $type: 'User',
  id: 'uuid!',
  email: 'string#',
  name: 'string',
  age: 'int?',
  balance: 'decimal',
  tags: 'string[]',
  createdAt: 'timestamp',
});

// Option 1: Use the adapter directly
const adapter = new PostgresAdapter();
const ddl = adapter.transform(schema, { ifNotExists: true });
const sql = adapter.serialize(ddl);

// Option 2: Use the convenience function
const sql2 = transformToPostgresDDL(schema, {
  ifNotExists: true,
  schema: 'public',
});

console.log(sql2);
// CREATE TABLE IF NOT EXISTS "public"."User" (
//   "$id" TEXT NOT NULL,
//   "$type" TEXT NOT NULL,
//   "$version" INTEGER NOT NULL DEFAULT 1,
//   "$createdAt" BIGINT NOT NULL,
//   "$updatedAt" BIGINT NOT NULL,
//   "id" UUID NOT NULL,
//   "email" TEXT UNIQUE,
//   "name" TEXT,
//   "age" INTEGER,
//   "balance" DECIMAL(38, 9),
//   "tags" TEXT[],
//   "createdAt" TIMESTAMP,
//   PRIMARY KEY ("$id"),
//   UNIQUE ("email")
// );
```

## PostgresAdapter Class

The main adapter class that implements the `SchemaAdapter` interface.

### Constructor

```typescript
import { PostgresAdapter } from '@icetype/postgres';

const adapter = new PostgresAdapter();
```

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `name` | `string` | `'postgres'` - Adapter identifier |
| `version` | `string` | `'0.1.0'` - Adapter version |

### Methods

#### `transform(schema, options?)`

Transforms an IceType schema to a PostgreSQL DDL structure.

```typescript
const ddl = adapter.transform(schema, {
  ifNotExists: true,
  schema: 'public',
  includeSystemFields: true,
});
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `schema` | `IceTypeSchema` | Parsed IceType schema |
| `options` | `PostgresAdapterOptions` | Optional configuration |

**Returns:** `PostgresDDL`

---

#### `serialize(output)`

Serializes a PostgreSQL DDL structure to a CREATE TABLE SQL statement.

```typescript
const sql = adapter.serialize(ddl);
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `output` | `PostgresDDL` | DDL structure to serialize |

**Returns:** `string` - SQL CREATE TABLE statement

---

#### `serializeWithIndexes(ddl)`

Generates DDL including CREATE INDEX statements for indexed columns.

```typescript
const sqlWithIndexes = adapter.serializeWithIndexes(ddl);
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `ddl` | `PostgresDDL` | DDL structure |

**Returns:** `string` - Full DDL including CREATE INDEX statements

## Convenience Functions

### `createPostgresAdapter()`

Factory function to create a new PostgreSQL adapter instance.

```typescript
import { createPostgresAdapter } from '@icetype/postgres';

const adapter = createPostgresAdapter();
```

**Returns:** `PostgresAdapter`

---

### `transformToPostgresDDL(schema, options?)`

Transforms an IceType schema directly to a PostgreSQL CREATE TABLE statement.

```typescript
import { parseSchema } from '@icetype/core';
import { transformToPostgresDDL } from '@icetype/postgres';

const schema = parseSchema({
  $type: 'User',
  id: 'uuid!',
  email: 'string#',
});

const sql = transformToPostgresDDL(schema, { ifNotExists: true });
console.log(sql);
// CREATE TABLE IF NOT EXISTS "User" (
//   ...
// );
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `schema` | `IceTypeSchema` | Parsed IceType schema |
| `options` | `PostgresAdapterOptions` | Optional configuration |

**Returns:** `string` - SQL CREATE TABLE statement

---

### `generatePostgresDDL(schema, options?)`

Transforms an IceType schema to a PostgreSQL DDL structure (without serializing to SQL).

```typescript
import { generatePostgresDDL } from '@icetype/postgres';

const ddl = generatePostgresDDL(schema, {
  tableName: 'users',
  schema: 'public',
});
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `schema` | `IceTypeSchema` | Parsed IceType schema |
| `options` | `PostgresAdapterOptions` | Optional configuration |

**Returns:** `PostgresDDL`

## DDL Helper Functions

### `mapIceTypeToPostgres(iceType)`

Maps an IceType type to its PostgreSQL equivalent.

```typescript
import { mapIceTypeToPostgres } from '@icetype/postgres';

const mapping = mapIceTypeToPostgres('string');
// { postgresType: 'TEXT' }

const decimalMapping = mapIceTypeToPostgres('decimal');
// { postgresType: 'DECIMAL', precision: 38, scale: 9 }
```

---

### `getPostgresTypeString(mapping, field?)`

Gets the PostgreSQL type string with precision/scale if applicable.

```typescript
import { getPostgresTypeString } from '@icetype/postgres';

const typeStr = getPostgresTypeString({ postgresType: 'DECIMAL', precision: 10, scale: 2 });
// 'DECIMAL(10, 2)'
```

---

### `toArrayType(baseType)`

Converts a base PostgreSQL type to its array equivalent.

```typescript
import { toArrayType } from '@icetype/postgres';

const arrayType = toArrayType('TEXT');
// 'TEXT[]'
```

---

### `fieldToPostgresColumn(name, field)`

Converts an IceType field definition to a PostgreSQL column definition.

```typescript
import { fieldToPostgresColumn } from '@icetype/postgres';
import { parseField } from '@icetype/core';

const field = parseField('string#');
const column = fieldToPostgresColumn('email', field);
// { name: 'email', type: 'TEXT', nullable: false, unique: true }
```

---

### `escapeIdentifier(identifier)`

Escapes a PostgreSQL identifier (table or column name).

```typescript
import { escapeIdentifier } from '@icetype/postgres';

const escaped = escapeIdentifier('user');
// '"user"'
```

---

### `serializeDDL(ddl)`

Serializes a complete DDL structure to SQL.

```typescript
import { serializeDDL } from '@icetype/postgres';

const sql = serializeDDL(ddl);
```

---

### `generateIndexStatements(tableName, schemaName, columns)`

Generates CREATE INDEX statements for indexed columns.

```typescript
import { generateIndexStatements } from '@icetype/postgres';

const indexes = generateIndexStatements('users', 'public', columns);
// ['CREATE INDEX "idx_users_email" ON "public"."users" ("email");']
```

## Options Reference

### `PostgresAdapterOptions`

Options for the PostgreSQL adapter.

```typescript
interface PostgresAdapterOptions {
  // Override the table name (defaults to schema name)
  tableName?: string;

  // PostgreSQL schema name (defaults to 'public')
  schema?: string;

  // Add IF NOT EXISTS clause
  ifNotExists?: boolean;

  // Include system fields ($id, $type, $version, $createdAt, $updatedAt)
  includeSystemFields?: boolean;  // default: true

  // Use UNLOGGED table for better write performance (no crash recovery)
  unlogged?: boolean;
}
```

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `tableName` | `string` | Schema name | Override the generated table name |
| `schema` | `string` | `undefined` | PostgreSQL schema (e.g., `'public'`) |
| `ifNotExists` | `boolean` | `undefined` | Add `IF NOT EXISTS` clause |
| `includeSystemFields` | `boolean` | `true` | Include IceType system columns |
| `unlogged` | `boolean` | `undefined` | Create unlogged table |

## Type Mappings

The following table shows how IceType types map to PostgreSQL types:

| IceType | PostgreSQL | Notes |
|---------|------------|-------|
| `string` | `TEXT` | Variable-length string |
| `text` | `TEXT` | Alias for string |
| `varchar` | `VARCHAR` | Variable-length with limit |
| `int` | `INTEGER` | 32-bit integer |
| `long` | `BIGINT` | 64-bit integer |
| `bigint` | `BIGINT` | Alias for long |
| `float` | `REAL` | 32-bit floating point |
| `double` | `DOUBLE PRECISION` | 64-bit floating point |
| `bool` | `BOOLEAN` | True/false |
| `boolean` | `BOOLEAN` | Alias for bool |
| `uuid` | `UUID` | UUID type |
| `timestamp` | `TIMESTAMP` | Date and time without timezone |
| `timestamptz` | `TIMESTAMPTZ` | Date and time with timezone |
| `date` | `DATE` | Date only |
| `time` | `TIME` | Time only |
| `json` | `JSONB` | Binary JSON (preferred for performance) |
| `binary` | `BYTEA` | Binary data |
| `decimal` | `DECIMAL(38, 9)` | High-precision decimal |

### Array Types

IceType arrays are mapped to PostgreSQL array types:

```typescript
// IceType -> PostgreSQL
'string[]'  -> 'TEXT[]'
'int[]'     -> 'INTEGER[]'
'uuid[]'    -> 'UUID[]'
```

## Types

### `PostgresDDL`

The DDL structure containing all information for table creation.

```typescript
interface PostgresDDL {
  tableName: string;
  schemaName?: string;
  columns: PostgresColumn[];
  primaryKey?: string[];
  uniqueConstraints?: string[][];
  ifNotExists?: boolean;
  unlogged?: boolean;
  checkConstraints?: Array<{
    name?: string;
    expression: string;
  }>;
  foreignKeys?: Array<{
    columns: string[];
    references: {
      table: string;
      columns: string[];
    };
    onDelete?: 'CASCADE' | 'SET NULL' | 'SET DEFAULT' | 'RESTRICT' | 'NO ACTION';
    onUpdate?: 'CASCADE' | 'SET NULL' | 'SET DEFAULT' | 'RESTRICT' | 'NO ACTION';
  }>;
}
```

### `PostgresColumn`

Column definition for DDL generation.

```typescript
interface PostgresColumn {
  name: string;
  type: string;
  nullable: boolean;
  default?: string;
  primaryKey?: boolean;
  unique?: boolean;
  precision?: number;
  scale?: number;
  length?: number;
  isArray?: boolean;
}
```

### `PostgresType`

Union of PostgreSQL native data types.

```typescript
type PostgresType =
  | 'TEXT'
  | 'VARCHAR'
  | 'CHAR'
  | 'INTEGER'
  | 'BIGINT'
  | 'SMALLINT'
  | 'SERIAL'
  | 'BIGSERIAL'
  | 'REAL'
  | 'DOUBLE PRECISION'
  | 'BOOLEAN'
  | 'UUID'
  | 'TIMESTAMP'
  | 'TIMESTAMPTZ'
  | 'DATE'
  | 'TIME'
  | 'INTERVAL'
  | 'JSON'
  | 'JSONB'
  | 'BYTEA'
  | 'DECIMAL'
  | 'NUMERIC'
  | 'INET'
  | 'CIDR'
  | 'MACADDR';
```

## System Columns

When `includeSystemFields` is `true` (the default), the following system columns are added:

| Column | Type | Description |
|--------|------|-------------|
| `$id` | `TEXT NOT NULL` | Primary key identifier |
| `$type` | `TEXT NOT NULL` | Entity type name |
| `$version` | `INTEGER NOT NULL DEFAULT 1` | Optimistic concurrency version |
| `$createdAt` | `BIGINT NOT NULL` | Creation timestamp (epoch ms) |
| `$updatedAt` | `BIGINT NOT NULL` | Last update timestamp (epoch ms) |
